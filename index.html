<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Contact Lens Scanner ‚Äî Live Auto‚ÄëScan (Big Box)</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;background:#0f172a;color:#e5e7eb}
  .container{max-width:1100px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:16px}
  .card{background:#0b1223;border:1px solid #1f2937;border-radius:14px;padding:14px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media (max-width: 1000px){.grid{grid-template-columns:1fr}}
  h1{font-size:1.6rem}
  .wrap{position:relative;border:1px dashed #334155;border-radius:12px;background:#0a0f1f;min-height:300px;display:flex;align-items:center;justify-content:center}
  video{max-width:100%;display:block}
  #frame{display:none}
  canvas{max-width:100%}
  #overlay{position:absolute;inset:0;pointer-events:none}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{background:#1f2937;border:1px solid #374151;border-radius:999px;padding:8px 14px;color:#fff;cursor:pointer;font-weight:600}
  .btn-primary{background:#3b82f6;border-color:#60a5fa}
  .btn-danger{background:#ef4444;border-color:#f87171}
  .pill{font-size:.8rem;background:#111827;border:1px solid #374151;border-radius:999px;padding:4px 8px}
  label{font-size:.9rem;color:#93c5fd}
  input{background:#0b1223;border:1px solid #334155;border-radius:10px;padding:8px 10px;color:#e5e7eb}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width: 720px){.row{grid-template-columns:1fr}}
  .hint{font-size:.9rem;background:#111827;border:1px solid #374151;border-radius:10px;padding:10px;color:#cbd5e1}
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>üì¶ Contact Lens Scanner ‚Äî Live Auto‚ÄëScan (Big Box)</h1>
    <div class="hint">Always uses a large fixed rectangle (~70% of frame) for OCR. Blue box shows the scan region.</div>
  </div>

  <div class="grid">
    <div class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <span id="chip-env" class="pill">env</span>
        <span id="chip-ocr" class="pill">ocr</span>
        <span id="chip-focus" class="pill">focus</span>
      </div>
      <div class="wrap">
        <video id="video" autoplay playsinline></video>
        <canvas id="frame"></canvas>
        <canvas id="overlay"></canvas>
        <div id="placeholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#64748b;text-align:center;padding:10px">
          Start camera ‚Üí toggle Live Scan. Blue box = big fixed region.
        </div>
      </div>
      <div class="controls">
        <button id="btnStart" class="btn btn-primary">üé• Start camera</button>
        <button id="btnStop" class="btn btn-danger" disabled>‚èπ Stop</button>
        <button id="btnLive" class="btn">‚ñ∂Ô∏è Live Scan: Off</button>
      </div>
    </div>

    <div class="card">
      <h3>Parsed Fields</h3>
      <div class="row">
        <div><label>Brand</label><input id="brand" placeholder="Acuvue Oasys"/></div>
        <div><label>Type</label><input id="type" placeholder="Daily, Monthly, Toric, etc."/></div>
      </div>
      <div class="row">
        <div><label>Power (SPH)</label><input id="power" placeholder="-1.25"/></div>
        <div><label>CYL</label><input id="cyl" placeholder="-0.75"/></div>
      </div>
      <div class="row">
        <div><label>AXIS</label><input id="axis" placeholder="10‚Äì180"/></div>
        <div><label>BC</label><input id="bc" placeholder="8.5"/></div>
      </div>
      <div class="row">
        <div><label>DIA</label><input id="dia" placeholder="14.0"/></div>
        <div><label>Expiry</label><input id="expiry" type="date"/></div>
      </div>
    </div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const chip=(el,txt,ok)=>{el.textContent=txt; el.style.background=ok?'#065f46':'#3f1d1d'};
const secure = location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1';
chip($('chip-env'), secure?'Secure ‚úÖ':'Not secure (no cam) ‚ùå', secure);

let worker=null;
async function ensureWorker(){
  if(!worker){
    chip($('chip-ocr'),'OCR loading‚Ä¶',false);
    worker = await Tesseract.createWorker({logger:m=>{}});
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    await worker.setParameters({
      tessedit_pageseg_mode: '6',
      user_defined_dpi: '350',
      tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.+-/: ',
      preserve_interword_spaces: '1'
    });
    chip($('chip-ocr'),'OCR ready ‚úÖ',true);
  }
}

function cleanupText(t){ return (t||'').replace(/[‚Äî‚Äì]/g,'-').replace(/\bO\b/g,'0').replace(/\bI\b/g,'1').replace(/l/g,'1'); }
function parseStrict(text){
  const U = cleanupText(text.toUpperCase());
  const brandMatch = /(ACUVUE OASYS|ACUVUE|BIOFINITY|DAILIES|AIR OPTIX|PRECISION1|MYDAY|CLARITI|ULTRA|TOTAL|SOFLENS|INFUSE)/.exec(U);
  const typeMatch = /(DAILY|ONE[- ]DAY|MONTHLY|TORIC|MULTIFOCAL|ASTIGMATISM)/.exec(U);
  const powerMatch = /\b(?:PWR|POWER|SPH)\s*([+\-]?\d+(?:\.\d{1,2})?)/.exec(U);
  const cylMatch = /\bCYL\s*([+\-]?\d+(?:\.\d{1,2})?)/.exec(U);
  const axisMatch = /\bAX(?:IS)?\s*(\d{2,3})/.exec(U);
  const bcMatch = /\bBC\s*(\d+(?:\.\d)?)/.exec(U);
  const diaMatch = /\bDIA\s*(\d+(?:\.\d)?)/.exec(U);
  const expMatch = /(20\d{2}[-\/](0[1-9]|1[0-2])[-\/](0[1-9]|[12]\d|3[01]))/.exec(U);
  return {
    brand: brandMatch? brandMatch[1]:'',
    type: typeMatch? typeMatch[1]:'',
    power: powerMatch? powerMatch[1]:'',
    cyl: cylMatch? cylMatch[1]:'',
    axis: axisMatch? axisMatch[1]:'',
    bc: bcMatch? bcMatch[1]:'',
    dia: diaMatch? diaMatch[1]:'',
    expiryISO: expMatch? expMatch[1]:''
  };
}
function fillForm(f){
  if(f.brand) $('brand').value=f.brand;
  if(f.type) $('type').value=f.type;
  if(f.power) $('power').value=f.power;
  if(f.cyl) $('cyl').value=f.cyl;
  if(f.axis) $('axis').value=f.axis;
  if(f.bc) $('bc').value=f.bc;
  if(f.dia) $('dia').value=f.dia;
  if(f.expiryISO) $('expiry').value=f.expiryISO;
}

let autoscan=false;
let running=false;
async function autoscanTick(){
  if(!autoscan || running) return;
  const video=$('video'), frame=$('frame'), overlay=$('overlay');
  if(!video.videoWidth) return;
  running=true;
  frame.width=video.videoWidth; frame.height=video.videoHeight;
  frame.getContext('2d').drawImage(video,0,0,frame.width,frame.height);

  // big fixed box (70% of frame)
  const boxW = Math.round(frame.width*0.7);
  const boxH = Math.round(frame.height*0.7);
  const boxX = Math.round((frame.width-boxW)/2);
  const boxY = Math.round((frame.height-boxH)/2);
  const octx = overlay.getContext('2d'); overlay.width=frame.width; overlay.height=frame.height;
  octx.clearRect(0,0,overlay.width,overlay.height);
  octx.strokeStyle='#60a5fa'; octx.lineWidth=3; octx.strokeRect(boxX,boxY,boxW,boxH);

  // crop & upscale
  const cx=document.createElement('canvas'); cx.width=boxW; cx.height=boxH;
  cx.getContext('2d').drawImage(frame, boxX, boxY, boxW, boxH, 0,0, boxW, boxH);
  const up=document.createElement('canvas'); up.width=cx.width*2; up.height=cx.height*2;
  up.getContext('2d').imageSmoothingEnabled=false; up.getContext('2d').drawImage(cx,0,0,up.width,up.height);

  await ensureWorker();
  const {data:{text}} = await worker.recognize(up);
  const fields=parseStrict(text);
  fillForm(fields);
  running=false;
}

const video=$('video');
$('btnStart').onclick=async ()=>{
  try{
    if(!secure){ alert('Camera requires HTTPS or localhost'); return; }
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}},audio:false});
    video.srcObject = stream; await video.play();
    $('placeholder').style.display='none';
    $('btnStop').disabled=false;
  }catch(e){ alert('Camera error: '+e.message); }
};
$('btnStop').onclick=()=>{
  const s=video.srcObject; if(s){ s.getTracks().forEach(t=>t.stop()); }
  video.pause(); video.srcObject=null; $('btnStop').disabled=true;
  autoscan=false; $('btnLive').textContent='‚ñ∂Ô∏è Live Scan: Off';
};
$('btnLive').onclick=async ()=>{
  autoscan=!autoscan;
  $('btnLive').textContent= autoscan? '‚è∏Ô∏è Live Scan: On':'‚ñ∂Ô∏è Live Scan: Off';
  if(autoscan){ await ensureWorker(); }
};
setInterval(()=>autoscanTick(),1000);
</script>
</body>
</html>