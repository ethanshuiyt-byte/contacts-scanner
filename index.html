<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Contact Lens Scanner ‚Äî Strict (Acuvue-tuned)</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;background:#0f172a;color:#e5e7eb}
  .container{max-width:1100px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:16px}
  .card{background:#0b1223;border:1px solid #1f2937;border-radius:14px;padding:14px}
  h1{font-size:1.6rem;margin-bottom:6px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
  @media (max-width: 1000px){.grid{grid-template-columns:1fr}}
  .wrap{position:relative;border:1px dashed #334155;border-radius:12px;background:#0a0f1f;min-height:300px;display:flex;align-items:center;justify-content:center}
  video{max-width:100%;display:block}
  #frame{display:none} /* single preview (video) */
  canvas{max-width:100%}
  #overlay{position:absolute;inset:0}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{background:#1f2937;border:1px solid #374151;border-radius:999px;padding:8px 14px;color:#fff;cursor:pointer;font-weight:600}
  .btn-primary{background:#3b82f6;border-color:#60a5fa}
  .btn-danger{background:#ef4444;border-color:#f87171}
  .pill{font-size:.8rem;background:#111827;border:1px solid #374151;border-radius:999px;padding:4px 8px}
  .hint{font-size:.9rem;background:#111827;border:1px solid #374151;border-radius:10px;padding:10px;color:#cbd5e1;margin-top:8px}
  label{font-size:.9rem;color:#93c5fd}
  input{background:#0b1223;border:1px solid #334155;border-radius:10px;padding:8px 10px;color:#e5e7eb}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width: 720px){.row{grid-template-columns:1fr}}
  .toast{position:fixed;top:16px;right:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.25);z-index:9999}
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0"></script>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>üì¶ Contact Lens Scanner ‚Äî Strict</h1>
    <div class="hint">
      This build is tuned for labels like <b>ACUVUE OASYS</b>. Draw a tight <b>ROI</b> around the printed label that contains <code>PWR/SPH</code>, <code>CYL</code>, <code>AX</code>, <code>BC</code>, <code>DIA</code>, and the <code>YYYY-MM-DD</code> expiry. Then click <b>Scan ROI</b>.
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <span id="chip-env" class="pill">env</span>
        <span id="chip-ocr" class="pill">ocr</span>
        <span id="chip-bar" class="pill">barcode</span>
      </div>
      <div class="wrap">
        <video id="video" autoplay playsinline></video>
        <canvas id="frame"></canvas>
        <canvas id="overlay"></canvas>
        <div id="placeholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#64748b">Start camera or upload photo, then draw ROI</div>
      </div>
      <div class="controls">
        <button id="btnStart" class="btn btn-primary">üé• Start camera</button>
        <button id="btnStop" class="btn btn-danger" disabled>‚èπ Stop</button>
        <button id="btnScanRoi" class="btn" disabled>üü¶ Scan ROI</button>
        <label class="btn" for="file">üñº Upload photo</label>
        <input id="file" type="file" accept="image/*" style="display:none"/>
      </div>
      <div class="hint">For best results: put only the white printed label inside the ROI. Avoid fingers/wood table/background.</div>
    </div>

    <div class="card">
      <h3>Parsed Fields</h3>
      <div class="row">
        <div><label>Brand</label><input id="brand" placeholder="Acuvue Oasys"/></div>
        <div><label>Type</label><input id="type" placeholder="Daily, Monthly, Toric, etc."/></div>
      </div>
      <div class="row">
        <div><label>Power (SPH)</label><input id="power" placeholder="-1.25"/></div>
        <div><label>CYL</label><input id="cyl" placeholder="-0.75"/></div>
      </div>
      <div class="row">
        <div><label>AXIS</label><input id="axis" placeholder="10‚Äì180"/></div>
        <div><label>BC</label><input id="bc" placeholder="8.5"/></div>
      </div>
      <div class="row">
        <div><label>DIA</label><input id="dia" placeholder="14.0"/></div>
        <div><label>Expiry</label><input id="expiry" type="date"/></div>
      </div>
    </div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const toast=(m)=>{const t=document.createElement('div');t.className='toast';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),2200)};
const chip=(el,txt,ok)=>{el.textContent=txt; el.style.background=ok?'#065f46':'#3f1d1d'};
const secure = location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1';
chip($('chip-env'), secure?'Secure ‚úÖ':'Not secure (no cam) ‚ùå', secure);

let worker=null;
async function ensureWorker(){
  if(!worker){
    chip($('chip-ocr'),'OCR loading‚Ä¶',false);
    worker = await Tesseract.createWorker({logger:()=>{}});
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    await worker.setParameters({
      tessedit_pageseg_mode: '6',
      user_defined_dpi: '350',
      tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.+-/: ',
      preserve_interword_spaces: '1'
    });
    chip($('chip-ocr'),'OCR ready ‚úÖ',true);
  }
}

function normalize(t){ return (t||'').replace(/[‚Äî‚Äì]/g,'-'); }
function cleanupText(t){
  // Acuvue labels are clean; but correct a few OCR confusions
  return normalize(t).replace(/\bO\b/g,'0').replace(/\bI\b/g,'1').replace(/l/g,'1');
}

// Strict patterns (Acuvue-like)
const brandList=['ACUVUE','ACUVUE OASYS','OASYS','BIOFINITY','DAILIES','AIR OPTIX','PRECISION1','MYDAY','CLARITI'];
const typeList=['DAILY','ONE-DAY','ONE DAY','MONTHLY','TORIC','MULTIFOCAL','ASTIGMATISM'];
function parseStrict(text){
  const U = cleanupText(text.toUpperCase()).replace(/[_|]/g,' ').replace(/\s{2,}/g,' ');

  // Only accept brands that actually appear in the OCR text
  let brand = brandList.find(b=>U.includes(b)) || '';
  if(brand==='OASYS' && U.includes('ACUVUE')) brand='ACUVUE OASYS';

  // Type only if present in text
  const type = typeList.find(t=>U.includes(t)) || '';

  // Core row extraction: prefer labeled groups inside ROI
  // e.g., "PWR -1.25  CYL -0.75  AX 180  BC 8.5  DIA 14.0  2026-07-01"
  const rxLine = /\b(?:PWR|POWER|SPH)\s*([+\-]?\d{1,2}(?:\.\d{2})?)\b(?:.*?\bCYL\s*([+\-]?\d(?:\.\d{2})?))?(?:.*?\bAX(?:IS)?\s*(\d{2,3}))?(?:.*?\bBC\s*(\d(?:\.\d{1,2})?))?(?:.*?\bDIA\s*(\d{2}(?:\.\d)?))?/;
  const mLine = U.match(rxLine);

  // Labeled singles as backup
  const mPwr  = U.match(/\b(?:PWR|POWER|SPH)\s*([+\-]?\d{1,2}(?:\.\d{2})?)/);
  const mCyl  = U.match(/\bCYL\s*([+\-]?\d(?:\.\d{2})?)/);
  const mAx   = U.match(/\bAX(?:IS)?\s*(\d{2,3})/);
  const mBc   = U.match(/\bBC\s*(\d(?:\.\d{1,2})?)/);
  const mDia  = U.match(/\bDIA\s*(\d{2}(?:\.\d)?)/);

  // Expiry: prefer ISO YYYY-MM-DD (as in your screenshot)
  let expiryISO='';
  const mExpISO = U.match(/\b(20\d{2})[-\/\. ](0[1-9]|1[0-2])[-\/\. ](0[1-9]|[12]\d|3[01])\b/);
  if(mExpISO){ expiryISO = `${mExpISO[1]}-${mExpISO[2]}-${mExpISO[3]}`; }
  else{
    // fallback formats
    const mExpYM = U.match(/\b(20\d{2})[-\/\. ](0[1-9]|1[0-2])\b/);
    const mExpMY = U.match(/\b(0[1-9]|1[0-2])[-\/](\d{2})\b/);
    if(mExpISO){ /* already handled */ }
    else if(mExpYM){ expiryISO = `${mExpYM[1]}-${mExpYM[2]}-01`; }
    else if(mExpMY){ expiryISO = `20${mExpMY[2]}-${mExpMY[1]}-01`; }
  }

  return {
    brand: brand? brand.toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()) : '',
    type: type? type.toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()) : '',
    power: (mLine && mLine[1]) || (mPwr && mPwr[1]) || '',
    cyl:   (mLine && mLine[2]) || (mCyl && mCyl[1]) || '',
    axis:  (mLine && mLine[3]) || (mAx && mAx[1]) || '',
    bc:    (mLine && mLine[4]) || (mBc && mBc[1]) || '',
    dia:   (mLine && mLine[5]) || (mDia && mDia[1]) || '',
    expiryISO
  };
}

function fillForm(f){
  const m=(k,v)=>{ if(v) $(k).value=v; };
  m('brand',f.brand); m('type',f.type);
  m('power',f.power); m('cyl',f.cyl); m('axis',f.axis);
  m('bc',f.bc); m('dia',f.dia); if(f.expiryISO) $('expiry').value=f.expiryISO;
}

const video=$('video'), frame=$('frame'), overlay=$('overlay');
const fctx=frame.getContext('2d'), octx=overlay.getContext('2d');
let stream=null, track=null, roi=null, dragging=false, startPt=null;

function drawROI(){ octx.clearRect(0,0,overlay.width,overlay.height); if(roi){ octx.strokeStyle='#60a5fa'; octx.lineWidth=2; octx.strokeRect(roi.x,roi.y,roi.w,roi.h);} }
overlay.addEventListener('mousedown',(e)=>{
  const r=overlay.getBoundingClientRect(); dragging=true; startPt={x:e.clientX-r.left,y:e.clientY-r.top};
  roi={x:startPt.x,y:startPt.y,w:0,h:0}; drawROI();
});
overlay.addEventListener('mousemove',(e)=>{ if(!dragging) return; const r=overlay.getBoundingClientRect();
  roi.w=(e.clientX-r.left)-startPt.x; roi.h=(e.clientY-r.top)-startPt.y; drawROI();
});
overlay.addEventListener('mouseup',()=>{ dragging=false; if(roi){ roi.w=Math.abs(roi.w); roi.h=Math.abs(roi.h); if(roi.w<10||roi.h<10) roi=null; drawROI(); $('btnScanRoi').disabled=!roi; }});

function applyPreprocess(c){
  const ctx=c.getContext('2d'); const d=ctx.getImageData(0,0,c.width,c.height); const a=d.data;
  // grayscale + mild sharpen + binarize threshold auto-ish
  for(let i=0;i<a.length;i+=4){ const g=0.2126*a[i]+0.7152*a[i+1]+0.0722*a[i+2]; a[i]=a[i+1]=a[i+2]=g; }
  const w=d.width,h=d.height; const out=new Uint8ClampedArray(a.length);
  const idx=(x,y)=> (y*w+x)*4;
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      const i=idx(x,y);
      const g=(a[idx(x-1,y-1)] + a[idx(x,y-1)] + a[idx(x+1,y-1)] +
               a[idx(x-1,y)]   - 8*a[i]       + a[idx(x+1,y)] +
               a[idx(x-1,y+1)] + a[idx(x,y+1)] + a[idx(x+1,y+1)]);
      const v = Math.max(0, Math.min(255, a[i] - 0.30*g));
      out[i]=out[i+1]=out[i+2]=v; out[i+3]=255;
    }
  }
  for(let i=0;i<a.length;i++){ a[i]=out[i]; }
  // adaptive-ish threshold (simple median-based)
  let sum=0,cnt=0; for(let i=0;i<a.length;i+=4){ sum+=a[i]; cnt++; }
  const thr = Math.max(100, Math.min(180, Math.round(sum/cnt))); // 100..180
  for(let i=0;i<a.length;i+=4){ const v=a[i]>=thr?255:0; a[i]=a[i+1]=a[i+2]=v; }
  ctx.putImageData(d,0,0);
  return c;
}

async function scanROIFromCanvas(canvas){
  if(!roi){ toast('Draw an ROI first'); return; }
  const cx=document.createElement('canvas'); cx.width=Math.max(1,roi.w); cx.height=Math.max(1,roi.h);
  cx.getContext('2d').drawImage(canvas, roi.x, roi.y, roi.w, roi.h, 0,0, cx.width, cx.height);
  // upscale to help OCR
  const up=document.createElement('canvas'); up.width=cx.width*2; up.height=cx.height*2; up.getContext('2d').drawImage(cx,0,0,up.width,up.height);
  applyPreprocess(up);

  // barcode first (try-harder)
  try{
    const hints=new Map(); hints.set(ZXing.DecodeHintType.TRY_HARDER,true);
    const reader=new ZXing.BrowserMultiFormatReader(hints);
    const src=new ZXing.HTMLCanvasElementLuminanceSource(up);
    const bmp=new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(src));
    const out=reader.decode(bmp);
    if(out && out.getText()){
      fillForm(parseStrict(out.getText())); chip($('chip-bar'),'barcode ‚úì',true); return true;
    }
  }catch(e){ /* ignore */ }

  await ensureWorker();
  const { data:{ text } } = await worker.recognize(up);
  const fields = parseStrict(text||'');
  fillForm(fields);
  return true;
}

// camera
$('btnStart').onclick=async ()=>{
  try{
    if(!secure){ toast('Use HTTPS or localhost'); return; }
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:2560},height:{ideal:1440}},audio:false});
    window.__stream = stream;
    video.srcObject=stream; await video.play();
    $('placeholder').style.display='none';
    frame.width=video.videoWidth; frame.height=video.videoHeight;
    overlay.width=video.videoWidth; overlay.height=video.videoHeight;
    $('btnStop').disabled=false;
    chip($('chip-bar'), 'ZXing fallback', true);
  }catch(e){ toast('Camera error: '+e.message); }
};
$('btnStop').onclick=()=>{
  if(window.__stream){ window.__stream.getTracks().forEach(t=>t.stop()); window.__stream=null; }
  video.pause(); video.srcObject=null;
  $('btnStop').disabled=true;
};
$('btnScanRoi').onclick=async ()=>{
  if(video.videoWidth){
    frame.width=video.videoWidth; frame.height=video.videoHeight;
    fctx.drawImage(video,0,0,frame.width,frame.height);
    await scanROIFromCanvas(frame);
  } else {
    await scanROIFromCanvas(frame);
  }
};

// upload photo
$('file').onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const img=new Image();
  img.onload=()=>{
    const scale=Math.min(1, 2000/img.width);
    frame.width=Math.round(img.width*scale); frame.height=Math.round(img.height*scale);
    fctx.drawImage(img,0,0,frame.width,frame.height);
    overlay.width=frame.width; overlay.height=frame.height;
    $('placeholder').style.display='none';
    $('btnScanRoi').disabled=false;
  };
  img.src=URL.createObjectURL(f);
};
</script>
</body>
</html>
