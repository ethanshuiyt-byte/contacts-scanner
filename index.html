<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Contact Lens Scanner ‚Äî Auto Label (Fixed)</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;background:#0f172a;color:#e5e7eb}
  .container{max-width:1100px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:16px}
  .card{background:#0b1223;border:1px solid #1f2937;border-radius:14px;padding:14px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media (max-width: 1000px){.grid{grid-template-columns:1fr}}
  h1{font-size:1.6rem}
  .wrap{position:relative;border:1px dashed #334155;border-radius:12px;background:#0a0f1f;min-height:300px;display:flex;align-items:center;justify-content:center}
  video{max-width:100%;display:block}
  #frame{display:none}
  canvas{max-width:100%}
  #overlay{position:absolute;inset:0;pointer-events:none}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{background:#1f2937;border:1px solid #374151;border-radius:999px;padding:8px 14px;color:#fff;cursor:pointer;font-weight:600}
  .btn-primary{background:#3b82f6;border-color:#60a5fa}
  .btn-danger{background:#ef4444;border-color:#f87171}
  .pill{font-size:.8rem;background:#111827;border:1px solid #374151;border-radius:999px;padding:4px 8px}
  label{font-size:.9rem;color:#93c5fd}
  input{background:#0b1223;border:1px solid #334155;border-radius:10px;padding:8px 10px;color:#e5e7eb}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width: 720px){.row{grid-template-columns:1fr}}
  .hint{font-size:.9rem;background:#111827;border:1px solid #374151;border-radius:10px;padding:10px;color:#cbd5e1}
  .logs{font-family:ui-monospace,monospace;background:#0b1021;border:1px solid #1f2937;border-radius:10px;padding:10px;max-height:220px;overflow:auto;color:#d1d5db}
  .ok{color:#10b981}.warn{color:#f59e0b}.err{color:#ef4444}
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>üì¶ Contact Lens Scanner ‚Äî Auto Label (Fixed)</h1>
    <div class="hint">No barcode or ROI. The app finds the largest bright rectangular <b>label</b>, highlights it in blue, and OCRs only that crop. Works with camera or uploaded photo.</div>
  </div>

  <div class="grid">
    <div class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <span id="chip-env" class="pill">env</span>
        <span id="chip-ocr" class="pill">ocr</span>
        <span id="chip-label" class="pill">label</span>
      </div>
      <div class="wrap">
        <video id="video" autoplay playsinline></video>
        <canvas id="frame"></canvas>
        <canvas id="overlay"></canvas>
        <div id="placeholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#64748b;text-align:center;padding:10px">
          Start camera or upload a photo<br/>A blue box will appear on the detected label
        </div>
      </div>
      <div class="controls">
        <button id="btnStart" class="btn btn-primary">üé• Start camera</button>
        <button id="btnStop" class="btn btn-danger" disabled>‚èπ Stop</button>
        <button id="btnSnap" class="btn" disabled>üì∏ Snap & scan label</button>
        <button id="btnScanFull" class="btn">üß™ Scan whole frame (fallback)</button>
        <label class="btn" for="file">üñº Upload photo</label>
        <input id="file" type="file" accept="image/*" style="display:none"/>
      </div>
      <div class="logs" id="logs" hidden></div>
    </div>

    <div class="card">
      <h3>Parsed Fields</h3>
      <div class="row">
        <div><label>Brand</label><input id="brand" placeholder="Acuvue Oasys"/></div>
        <div><label>Type</label><input id="type" placeholder="Daily, Monthly, Toric, etc."/></div>
      </div>
      <div class="row">
        <div><label>Power (SPH)</label><input id="power" placeholder="-1.25"/></div>
        <div><label>CYL</label><input id="cyl" placeholder="-0.75"/></div>
      </div>
      <div class="row">
        <div><label>AXIS</label><input id="axis" placeholder="10‚Äì180"/></div>
        <div><label>BC</label><input id="bc" placeholder="8.5"/></div>
      </div>
      <div class="row">
        <div><label>DIA</label><input id="dia" placeholder="14.0"/></div>
        <div><label>Expiry</label><input id="expiry" type="date"/></div>
      </div>
    </div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const logBox=$('logs'); const log=(lvl,msg)=>{logBox.hidden=false; logBox.innerHTML += `<div class="${lvl}">${msg}</div>`; logBox.scrollTop=logBox.scrollHeight;};
const chip=(el,txt,ok)=>{el.textContent=txt; el.style.background=ok?'#065f46':'#3f1d1d'};
const secure = location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1';
chip($('chip-env'), secure?'Secure ‚úÖ':'Not secure (no cam) ‚ùå', secure);

let worker=null;
async function ensureWorker(){
  if(!worker){
    chip($('chip-ocr'),'OCR loading‚Ä¶',false);
    worker = await Tesseract.createWorker({logger:m=>{/* optionally show progress */}});
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    await worker.setParameters({
      tessedit_pageseg_mode: '6',
      user_defined_dpi: '350',
      tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.+-/: ',
      preserve_interword_spaces: '1'
    });
    chip($('chip-ocr'),'OCR ready ‚úÖ',true);
    log('ok','OCR ready');
  }
}

function normalize(t){ return (t||'').replace(/[‚Äî‚Äì]/g,'-'); }
function cleanupText(t){ return normalize(t).replace(/\bO\b/g,'0').replace(/\bI\b/g,'1').replace(/l/g,'1'); }

const brandList=['ACUVUE','ACUVUE OASYS','OASYS','BIOFINITY','DAILIES','AIR OPTIX','PRECISION1','MYDAY','CLARITI','ULTRA','TOTAL','SOFLENS','INFUSE'];
const typeList=['DAILY','ONE-DAY','ONE DAY','MONTHLY','TORIC','MULTIFOCAL','ASTIGMATISM'];
function parseStrict(text){
  const U = cleanupText(text.toUpperCase()).replace(/[_|]/g,' ').replace(/\s{2,}/g,' ');
  let brand = brandList.find(b=>U.includes(b)) || '';
  if(brand==='OASYS' && U.includes('ACUVUE')) brand='ACUVUE OASYS';
  const type = typeList.find(t=>U.includes(t)) || '';
  const rxLine = /\b(?:PWR|POWER|SPH)\s*([+\-]?\d{1,2}(?:\.\d{2})?)\b(?:.*?\bCYL\s*([+\-]?\d(?:\.\d{2})?))?(?:.*?\bAX(?:IS)?\s*(\d{2,3}))?(?:.*?\bBC\s*(\d(?:\.\d{1,2})?))?(?:.*?\bDIA\s*(\d{2}(?:\.\d)?))?/;
  const mLine = U.match(rxLine);
  const mPwr  = U.match(/\b(?:PWR|POWER|SPH)\s*([+\-]?\d{1,2}(?:\.\d{2})?)/);
  const mCyl  = U.match(/\bCYL\s*([+\-]?\d(?:\.\d{2})?)/);
  const mAx   = U.match(/\bAX(?:IS)?\s*(\d{2,3})/);
  const mBc   = U.match(/\bBC\s*(\d(?:\.\d{1,2})?)/);
  const mDia  = U.match(/\bDIA\s*(\d{2}(?:\.\d)?)/);
  let expiryISO='';
  const mExpISO = U.match(/\b(20\d{2})[-\/\. ](0[1-9]|1[0-2])[-\/\. ](0[1-9]|[12]\d|3[01])\b/);
  if(mExpISO){ expiryISO = `${mExpISO[1]}-${mExpISO[2]}-${mExpISO[3]}`; }
  else{
    const mExpYM = U.match(/\b(20\d{2})[-\/\. ](0[1-9]|1[0-2])\b/);
    const mExpMY = U.match(/\b(0[1-9]|1[0-2])[-\/](\d{2})\b/);
    if(mExpYM){ expiryISO = `${mExpYM[1]}-${mExpYM[2]}-01`; }
    else if(mExpMY){ expiryISO = `20${mExpMY[2]}-${mExpMY[1]}-01`; }
  }
  return {
    brand: brand? brand.toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()) : '',
    type: type? type.toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()) : '',
    power: (mLine && mLine[1]) || (mPwr && mPwr[1]) || '',
    cyl:   (mLine && mLine[2]) || (mCyl && mCyl[1]) || '',
    axis:  (mLine && mLine[3]) || (mAx && mAx[1]) || '',
    bc:    (mLine && mLine[4]) || (mBc && mBc[1]) || '',
    dia:   (mLine && mLine[5]) || (mDia && mDia[1]) || '',
    expiryISO
  };
}

function fillForm(f){
  const m=(k,v)=>{ if(v) $(k).value=v; };
  m('brand',f.brand); m('type',f.type);
  m('power',f.power); m('cyl',f.cyl); m('axis',f.axis);
  m('bc',f.bc); m('dia',f.dia); if(f.expiryISO) $('expiry').value=f.expiryISO;
}

function drawBox(ctx, box){
  ctx.strokeStyle='#60a5fa'; ctx.lineWidth=2;
  ctx.strokeRect(box.x, box.y, box.w, box.h);
}

// Robust white-label detection
function detectWhiteLabelBox(sourceCanvas){
  const MAXW = 420;
  const scale = Math.min(1, MAXW / sourceCanvas.width);
  const w = Math.round(sourceCanvas.width*scale), h = Math.round(sourceCanvas.height*scale);
  const s = document.createElement('canvas'); s.width=w; s.height=h;
  const sctx = s.getContext('2d', { willReadFrequently:true });
  sctx.drawImage(sourceCanvas,0,0,w,h);
  const img = sctx.getImageData(0,0,w,h);
  const d = img.data;

  const gray = new Uint8ClampedArray(w*h);
  for(let i=0,p=0;i<d.length;i+=4,p++){ gray[p] = (0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]); }

  // high threshold to isolate white-ish areas
  let mean=0; for(let i=0;i<gray.length;i++) mean+=gray[i]; mean/=gray.length;
  const thr = Math.max(180, mean+20);
  const bin = new Uint8Array(w*h);
  for(let i=0;i<gray.length;i++){ bin[i] = gray[i] >= thr ? 1 : 0; }

  // one-pass closing
  const bin2 = new Uint8Array(bin);
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      const i=y*w+x;
      if(bin[i]===0){
        const sum = bin[i-1]+bin[i+1]+bin[i-w]+bin[i+w]+bin[i-w-1]+bin[i-w+1]+bin[i+w-1]+bin[i+w+1];
        if(sum>=5) bin2[i]=1;
      }
    }
  }

  const visited = new Uint8Array(w*h);
  let best = {area:0,x:0,y:0,w:0,h:0, fill:0};
  const stackX = new Int32Array(w*h), stackY = new Int32Array(w*h);
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const idx = y*w+x;
      if(bin2[idx]===1 && !visited[idx]){
        let top=0; stackX[top]=x; stackY[top]=y; top++; visited[idx]=1;
        let minx=x,miny=y,maxx=x,maxy=y, area=0, ones=0;
        while(top){
          top--; const cx=stackX[top], cy=stackY[top]; const ci=cy*w+cx;
          area++; if(bin2[ci]) ones++;
          if(cx<minx)minx=cx; if(cx>maxx)maxx=cx; if(cy<miny)miny=cy; if(cy>maxy)maxy=cy;
          const nbh = [[1,0],[-1,0],[0,1],[0,-1]];
          for(const [dx,dy] of nbh){
            const nx=cx+dx, ny=cy+dy; if(nx<0||ny<0||nx>=w||ny>=h) continue;
            const ni=ny*w+nx; if(bin2[ni]===1 && !visited[ni]){ visited[ni]=1; stackX[top]=nx; stackY[top]=ny; top++; }
          }
        }
        const bw=maxx-minx+1, bh=maxy-miny+1, boxArea=bw*bh, fillRatio=area/boxArea, aspect=bw/bh;
        if(boxArea>best.area && fillRatio>0.55 && aspect>0.6 && aspect<3.2){
          best = {area:boxArea,x:minx,y:miny,w:bw,h:bh, fill:fillRatio};
        }
      }
    }
  }
  if(best.area===0){
    const fw=Math.round(w*0.6), fh=Math.round(h*0.6);
    const fx=Math.round((w-fw)/2), fy=Math.round((h-fh)/2);
    best = {x:fx,y:fy,w:fw,h:fh};
  }
  const scaleBack = 1/scale;
  return {
    x: Math.max(0, Math.round(best.x*scaleBack)),
    y: Math.max(0, Math.round(best.y*scaleBack)),
    w: Math.max(10, Math.round(best.w*scaleBack)),
    h: Math.max(10, Math.round(best.h*scaleBack))
  };
}

async function ocrLabel(canvas){
  await ensureWorker();
  const { data:{ text } } = await worker.recognize(canvas);
  const fields=parseStrict(text||'');
  fillForm(fields);
  if((text||'').trim().length===0) log('warn','OCR returned empty text ‚Äî try better lighting or upload a photo');
  else log('ok','OCR complete');
}

async function scanLabelFromCanvas(canvas){
  const box = detectWhiteLabelBox(canvas);
  const octx = $('overlay').getContext('2d');
  $('overlay').width = canvas.width; $('overlay').height = canvas.height;
  octx.clearRect(0,0,canvas.width,canvas.height);
  drawBox(octx, box);
  chip($('chip-label'), `label: ${box.w}x${box.h}`, true);

  const cx=document.createElement('canvas'); cx.width=box.w; cx.height=box.h;
  cx.getContext('2d').drawImage(canvas, box.x, box.y, box.w, box.h, 0,0, box.w, box.h);

  // upscale + preprocess (grayscale + mild sharpen + adaptive threshold)
  const up=document.createElement('canvas'); up.width=cx.width*2; up.height=cx.height*2; const uctx=up.getContext('2d');
  uctx.imageSmoothingEnabled=false; uctx.drawImage(cx,0,0,up.width,up.height);
  const img=uctx.getImageData(0,0,up.width,up.height); const a=img.data;
  for(let i=0;i<a.length;i+=4){ const g=0.2126*a[i]+0.7152*a[i+1]+0.0722*a[i+2]; a[i]=a[i+1]=a[i+2]=g; }
  const w=img.width,h=img.height; const out=new Uint8ClampedArray(a.length);
  const idx=(x,y)=> (y*w+x)*4;
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      const i=idx(x,y);
      const g=(a[idx(x-1,y-1)] + a[idx(x,y-1)] + a[idx(x+1,y-1)] +
               a[idx(x-1,y)]   - 8*a[i]       + a[idx(x+1,y)] +
               a[idx(x-1,y+1)] + a[idx(x,y+1)] + a[idx(x+1,y+1)]);
      const v = Math.max(0, Math.min(255, a[i] - 0.30*g));
      out[i]=out[i+1]=out[i+2]=v; out[i+3]=255;
    }
  }
  for(let i=0;i<a.length;i++){ a[i]=out[i]; }
  let sum=0,cnt=0; for(let i=0;i<a.length;i+=4){ sum+=a[i]; cnt++; }
  const thr = Math.max(100, Math.min(180, Math.round(sum/cnt)));
  for(let i=0;i<a.length;i+=4){ const v=a[i]>=thr?255:0; a[i]=a[i+1]=a[i+2]=v; }
  uctx.putImageData(img,0,0);

  await ocrLabel(up);
}

async function scanWholeFrame(canvas){
  // fallback OCR without label-detection
  $('overlay').width=canvas.width; $('overlay').height=canvas.height;
  $('overlay').getContext('2d').clearRect(0,0,canvas.width,canvas.height);
  await ocrLabel(canvas);
}

// camera & upload wiring
const video=$('video'), frame=$('frame'), fctx=frame.getContext('2d');
$('btnStart').onclick=async ()=>{
  try{
    if(!secure){ log('err','Camera requires HTTPS or localhost'); return; }
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:2560},height:{ideal:1440}},audio:false});
    video.srcObject = stream; await video.play();
    $('placeholder').style.display='none';
    $('btnStop').disabled=false; $('btnSnap').disabled=false;
    log('ok','Camera started');
  }catch(e){ log('err','Camera error: '+e.message); }
};
$('btnStop').onclick=()=>{
  const s=video.srcObject; if(s){ s.getTracks().forEach(t=>t.stop()); }
  video.pause(); video.srcObject=null; $('btnStop').disabled=true; $('btnSnap').disabled=true;
  log('warn','Camera stopped');
};
$('btnSnap').onclick=async ()=>{
  if(!video.videoWidth){ log('warn','Camera not ready'); return; }
  frame.width=video.videoWidth; frame.height=video.videoHeight;
  fctx.drawImage(video,0,0,frame.width,frame.height);
  await scanLabelFromCanvas(frame);
};
$('btnScanFull').onclick=async ()=>{
  if(video.videoWidth){
    frame.width=video.videoWidth; frame.height=video.videoHeight;
    fctx.drawImage(video,0,0,frame.width,frame.height);
    await scanWholeFrame(frame);
  } else {
    await scanWholeFrame(frame);
  }
};
$('file').onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const img=new Image();
  img.onload=async ()=>{
    const scale = Math.min(1, 2200/img.width);
    frame.width=Math.round(img.width*scale); frame.height=Math.round(img.height*scale);
    fctx.drawImage(img,0,0,frame.width,frame.height);
    $('placeholder').style.display='none';
    log('ok','Photo loaded ‚Äî scanning label‚Ä¶');
    await scanLabelFromCanvas(frame);
  };
  img.src=URL.createObjectURL(f);
};
</script>
</body>
</html>
