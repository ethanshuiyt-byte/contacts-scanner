<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contact Lens Box Scanner ‚Äî Real OCR & Barcode (Fixed)</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial,'Apple Color Emoji','Segoe UI Emoji';background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#1f2937}
    .container{max-width:1200px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:20px}
    .header{text-align:center;color:#fff}
    .header h1{font-size:2.2rem;text-shadow:0 2px 12px rgba(0,0,0,.3);margin-bottom:6px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.18)}
    .section-title{font-size:1.2rem;color:#374151;margin-bottom:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .camera-container{position:relative;border-radius:14px;overflow:hidden;background:#f3f4f6;border:2px dashed #cbd5e1;min-height:280px;display:flex;align-items:center;justify-content:center}
    video,canvas{max-width:100%}
    #video{width:100%;height:auto;display:none}
    #overlay{position:absolute;inset:0;pointer-events:none}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .btn{border:0;border-radius:999px;padding:10px 16px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:transform .15s,box-shadow .15s}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(102,126,234,.35)}
    .btn-danger{background:#e11d48;color:#fff}
    .btn-muted{background:#e5e7eb}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;color:#3730a3;border-radius:999px;padding:6px 10px;font-size:.85rem}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 720px){.row{grid-template-columns:1fr}}
    .form-group{display:flex;flex-direction:column;gap:6px}
    label{color:#374151;font-weight:600}
    input,select{border:2px solid #e5e7eb;border-radius:10px;padding:10px 12px;font-size:1rem}
    input:focus,select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.15)}
    .scan-result{background:#f8fafc;border-left:4px solid #667eea;border-radius:10px;padding:12px;margin-top:10px}
    .inventory-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:10px}
    .stat{background:#fff;border-radius:12px;padding:12px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .stat .n{font-size:1.6rem;color:#4f46e5;font-weight:800}
    .list{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:10px}
    .item{background:#fff;border-left:4px solid #22c55e;border-radius:10px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .logs{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0b1021;color:#d1d5db;border-radius:10px;padding:10px;max-height:200px;overflow:auto;font-size:.9rem}
    .k{color:#93c5fd}
    .v{color:#fbbf24}
    .toast{position:fixed;top:16px;right:16px;background:#111827;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.25);z-index:9999}
    .hint{font-size:.9rem;color:#374151;background:#fffbeb;border:1px solid #f59e0b;border-radius:10px;padding:10px;margin-top:8px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì¶ Contact Lens Box Scanner</h1>
      <p>Real barcode + OCR. Works with camera <em>(HTTPS/localhost only)</em> or uploaded photos.</p>
    </div>

    <div class="grid">
      <div class="card">
        <div class="section-title">
          üì∑ Scanner
          <span id="env-chip" class="pill"></span>
          <span id="bd-chip" class="pill"></span>
          <span id="ocr-chip" class="pill"></span>
        </div>
        <div class="camera-container">
          <video id="video" autoplay playsinline></video>
          <canvas id="overlay"></canvas>
          <div id="placeholder" style="text-align:center;color:#6b7280;position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor" style="opacity:.6"><path d="M9 2 7.17 4H4C2.9 4 2 4.9 2 6v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9Zm3 5c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6 2.69-6 6-6Zm0 2a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"/></svg>
            <div>Click <b>Start camera</b> (HTTPS/localhost) or upload a photo</div>
          </div>
        </div>
        <div class="controls">
          <button id="start" class="btn btn-primary">üé• Start camera</button>
          <button id="snap" class="btn btn-muted" disabled>üì∏ Scan current frame</button>
          <button id="stop" class="btn btn-danger" disabled>‚èπ Stop</button>
          <label class="btn btn-muted" for="file">üñº Upload photo</label>
          <input id="file" type="file" accept="image/*" style="display:none">
        </div>
        <div class="hint">
          If the camera won‚Äôt start: open this file via <b>https://</b> or <b>http://localhost</b> (required by browsers), then allow camera access. In Safari 17, native BarcodeDetector is not supported‚ÄîZXing fallback will be used.
        </div>
        <div class="scan-result" id="autoFields" style="display:none">
          <div><strong>Detected:</strong> <span id="detSummary">‚Äî</span></div>
        </div>
        <div class="logs" id="logs" hidden></div>
      </div>

      <div class="card">
        <div class="section-title">üìã Inventory</div>
        <div class="inventory-stats">
          <div class="stat"><div class="n" id="totalItems">0</div><div>Total Lenses</div></div>
          <div class="stat"><div class="n" id="totalBoxes">0</div><div>Total Boxes</div></div>
          <div class="stat"><div class="n" id="lowStock">0</div><div>Low Stock</div></div>
        </div>

        <div class="row">
          <div class="form-group"><label for="brand">Brand</label><input id="brand" placeholder="e.g., Acuvue, Biofinity"></div>
          <div class="form-group"><label for="type">Type</label><input id="type" placeholder="Daily, Monthly, Toric, etc."></div>
        </div>
        <div class="row">
          <div class="form-group"><label for="power">Power (SPH)</label><input id="power" placeholder="-2.50, +1.00"></div>
          <div class="form-group"><label for="cyl">CYL</label><input id="cyl" placeholder="-0.75, -1.25"></div>
        </div>
        <div class="row">
          <div class="form-group"><label for="axis">Axis</label><input id="axis" placeholder="10‚Äî180"></div>
          <div class="form-group"><label for="bc">BC</label><input id="bc" placeholder="8.6"></div>
        </div>
        <div class="row">
          <div class="form-group"><label for="dia">DIA</label><input id="dia" placeholder="14.0, 14.2"></div>
          <div class="form-group"><label for="qty">Quantity</label><input type="number" id="qty" min="1" value="30"></div>
        </div>
        <div class="row">
          <div class="form-group"><label for="expiry">Expiry Date</label><input type="date" id="expiry"></div>
          <div class="form-group"><label for="notes">Notes</label><input id="notes" placeholder="e.g., Left eye only, promo box‚Ä¶"></div>
        </div>
        <div class="controls">
          <button id="add" class="btn btn-primary">‚ûï Add to inventory</button>
          <button id="clear" class="btn btn-muted">üßπ Clear form</button>
        </div>
        <div class="list" id="list">
          <div style="text-align:center;color:#6b7280;padding:22px">No items yet ‚Äî scan a box.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const logBox = $('logs');
    const log = (msg)=>{ try{ logBox.hidden=false; logBox.innerHTML += (typeof msg==='string'?msg:JSON.stringify(msg)) + '\\n'; logBox.scrollTop=logBox.scrollHeight; }catch{} };
    const toast=(m)=>{const t=document.createElement('div');t.className='toast';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),2200)};

    // Env diagnostics
    const envChip = $('env-chip');
    const bdChip = $('bd-chip');
    const ocrChip = $('ocr-chip');
    function setChip(el, text, ok){
      el.textContent = text;
      el.style.background = ok ? '#dcfce7' : '#fee2e2';
      el.style.color = ok ? '#166534' : '#991b1b';
    }
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    setChip(envChip, isSecure ? 'Secure context ‚úÖ' : 'Not secure (no camera) ‚ùå', isSecure);
    setChip(bdChip, ('BarcodeDetector' in window) ? 'Native Barcode: On' : 'Native Barcode: Off (ZXing)', ('BarcodeDetector' in window));

    // Inventory store
    const storeKey='contactLensInventory';
    let inventory = JSON.parse(localStorage.getItem(storeKey)||'[]');
    function save(){ localStorage.setItem(storeKey, JSON.stringify(inventory)); }
    function renderList(){
      const list = $('list');
      if (!inventory.length) { list.innerHTML = '<div style="text-align:center;color:#6b7280;padding:22px">No items yet ‚Äî scan a box.</div>'; }
      else {
        list.innerHTML = inventory.map(it=>`
          <div class="item">
            <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
              <strong>${it.brand||'‚Äî'} ${it.type||''}</strong>
              <button class="btn btn-danger" style="padding:6px 10px" onclick="removeItem(${it.id})">Remove</button>
            </div>
            <div style="font-size:.95rem;color:#374151;margin-top:6px">
              <div><span class="k">SPH</span> <span class="v">${it.power||'‚Äî'}</span> <span class="k">CYL</span> <span class="v">${it.cyl||'‚Äî'}</span> <span class="k">AX</span> <span class="v">${it.axis||'‚Äî'}</span> <span class="k">BC</span> <span class="v">${it.bc||'‚Äî'}</span> <span class="k">DIA</span> <span class="v">${it.dia||'‚Äî'}</span></div>
              <div><span class="k">Qty</span> <span class="v">${it.qty}</span> <span class="k">Expiry</span> <span class="v">${it.expiry?new Date(it.expiry).toLocaleDateString(): '‚Äî'}</span></div>
              ${it.notes?`<div><span class="k">Notes</span> ${it.notes}</div>`:''}
            </div>
          </div>
        `).join('');
      }
      $('totalBoxes').textContent = inventory.length;
      $('totalItems').textContent = inventory.reduce((s,x)=>s+(+x.qty||0),0);
      $('lowStock').textContent = inventory.filter(x=>(+x.qty||0)<=10).length;
    }
    function removeItem(id){inventory=inventory.filter(it=>it.id!==id);save();renderList();toast('Removed');}
    renderList();

    function fillForm(fields){
      const m = (k,v)=>{ if(v){ $(k).value=v; } };
      m('brand',fields.brand);
      m('type',fields.type);
      m('power',fields.power);
      m('cyl',fields.cyl);
      m('axis',fields.axis);
      m('bc',fields.bc);
      m('dia',fields.dia);
      m('qty',fields.qty);
      m('expiry',fields.expiryISO);
      $('autoFields').style.display='block';
      $('detSummary').textContent = Object.entries(fields).filter(([k,v])=>v && !['expiryISO'].includes(k)).map(([k,v])=>`${k}: ${v}`).join(', ');
    }
    function clearForm(){['brand','type','power','cyl','axis','bc','dia','qty','expiry','notes'].forEach(id=>$(id).value='');$('autoFields').style.display='none';$('detSummary').textContent='‚Äî';}
    $('clear').onclick=clearForm;
    $('add').onclick=()=>{
      const item={
        id:Date.now(),
        brand:$('brand').value.trim(),
        type:$('type').value.trim(),
        power:$('power').value.trim(),
        cyl:$('cyl').value.trim(),
        axis:$('axis').value.trim(),
        bc:$('bc').value.trim(),
        dia:$('dia').value.trim(),
        qty:+$('qty').value||0,
        expiry:$('expiry').value||'',
        notes:$('notes').value.trim()
      };
      if(!item.brand || !item.qty){ toast('Brand and quantity required'); return; }
      inventory.push(item); save(); renderList(); clearForm(); toast('Added to inventory');
    };

    // Parse fields from text or barcode payload
    const brands = ['ACUVUE','BIOFINITY','AIR OPTIX','DAILIES','PROCLEAR','BAUSCH','ALCON','COOPER','PRECISION1','MYDAY','CLARITI','ULTRA','TOTAL','SOFLENS'];
    const types = ['DAILY','MONTHLY','BI-WEEKLY','TORIC','MULTIFOCAL','ASTIGMATISM'];
    function parseFields(text){
      const U = (text||'').toUpperCase().replace(/[_|]/g,' ').replace(/\s{2,}/g,' ');
      const brand = brands.find(b=>U.includes(b)) || '';
      const type = types.find(t=>U.includes(t)) || (U.includes('ONE DAY')?'DAILY':'');
      const powerMatch = U.match(/(?:SPH|PWR|POWER)[: ]*([+\-]?\d{0,2}(?:\.\d{2})?)/);
      const cylMatch   = U.match(/(?:CYL)[: ]*([+\-]?\d(?:\.\d{2})?)/);
      const axisMatch  = U.match(/(?:AXIS|AX)[: ]*(\d{2,3})/);
      const bcMatch    = U.match(/(?:BC|BASE CURVE)[: ]*(\d(?:\.\d{1,2})?)/);
      const diaMatch   = U.match(/(?:DIA|DIAM(?:ETER)?)[: ]*(\d{2}(?:\.\d)?)/);
      const qtyMatch   = U.match(/\b(30|90|6|12)\s*(?:PK|PACK|LENSES?)\b/);
      let expiryISO=''; 
      const exp1 = U.match(/(?:EXP|EXPI?RY|USE BY)[: ]*([0-9]{4})[-\/ ]([0-1][0-9])/);
      const exp2 = U.match(/(?:EXP|EXPI?RY|USE BY)[: ]*([0-1][0-9])[\/\-]([0-9]{2})/);
      const exp3 = U.match(/(?:EXP|EXPI?RY|USE BY)[: ]*([A-Z]{3})\s*([0-9]{4})/);
      if(exp1){ expiryISO = `${exp1[1]}-${exp1[2]}-01`; }
      else if(exp2){ const y = '20'+exp2[2]; const m = exp2[1]; expiryISO = `${y}-${m}-01`; }
      else if(exp3){ const months = {JAN:'01',FEB:'02',MAR:'03',APR:'04',MAY:'05',JUN:'06',JUL:'07',AUG:'08',SEP:'09',OCT:'10',NOV:'11',DEC:'12'}; const m = months[exp3[1]]||'01'; expiryISO = `${exp3[2]}-${m}-01`; }
      return {
        brand: brand?brand.toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()):'',
        type: type?type.toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()):'',
        power: powerMatch?powerMatch[1]:'',
        cyl: cylMatch?cylMatch[1]:'',
        axis: axisMatch?axisMatch[1]:'',
        bc: bcMatch?bcMatch[1]:'',
        dia: diaMatch?diaMatch[1]:'',
        qty: qtyMatch?qtyMatch[1]:'',
        expiryISO
      };
    }

    // Camera & scanning
    const video = $('video');
    const overlay = $('overlay');
    const ctx = overlay.getContext('2d');
    let stream=null, scanTimer=null, worker=null, usingBarcodeDetector=false, codeReader=null;

    async function ensureWorker(){
      if(!worker){
        setChip(ocrChip, 'OCR: loading‚Ä¶', false);
        worker = await Tesseract.createWorker({ logger: m => { /* could show progress */ } });
        await worker.loadLanguage('eng');
        await worker.initialize('eng');
        await worker.setParameters({
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.+-/: ',
          preserve_interword_spaces: '1'
        });
        setChip(ocrChip, 'OCR ready ‚úÖ', true);
      }
    }

    function drawBox(box,text){
      ctx.strokeStyle='rgba(79,70,229,.9)';
      ctx.lineWidth=3;
      ctx.strokeRect(box.x, box.y, box.w, box.h);
      ctx.fillStyle='rgba(17,24,39,.9)';
      ctx.fillRect(box.x, box.y-24, ctx.measureText(text).width+12, 20);
      ctx.fillStyle='#fff';
      ctx.fillText(text, box.x+6, box.y-9);
    }

    // Core scanning that works on any canvas source (camera frame or uploaded image)
    async function scanOnCanvas(sourceCanvas){
      overlay.width = sourceCanvas.width;
      overlay.height = sourceCanvas.height;
      ctx.clearRect(0,0,overlay.width,overlay.height);
      ctx.font='14px ui-monospace,monospace';

      // Try native BarcodeDetector
      if(usingBarcodeDetector){
        try{
          const barcodes = await window.__bd.detect(sourceCanvas);
          if(barcodes && barcodes.length){
            const b = barcodes[0];
            const rect = b.boundingBox || {x:20,y:20,width:160,height:50};
            drawBox({x:rect.x,y:rect.y,w:rect.width,h:rect.height}, `Barcode: ${b.rawValue}`);
            const fields = parseFields(b.rawValue);
            if(fields.qty || fields.brand){ fillForm(fields); toast('Barcode detected'); return true; }
          }
        }catch(e){ log('BD error: '+e.message); }
      }

      // ZXing fallback
      try{
        if(!codeReader){ codeReader = new ZXing.BrowserMultiFormatReader(); }
        const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(sourceCanvas);
        const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
        const result = codeReader.decode(binaryBitmap);
        if(result && result.getText()){
          drawBox({x:20,y:20,w:160,h:50}, 'Barcode (ZXing)');
          const fields = parseFields(result.getText());
          if(fields.qty || fields.brand){ fillForm(fields); toast('Barcode detected'); return true; }
        }
      }catch(e){ /* ignore */ }

      // OCR with Tesseract
      await ensureWorker();
      const off = document.createElement('canvas');
      off.width = sourceCanvas.width; off.height = sourceCanvas.height;
      const ictx = off.getContext('2d');
      ictx.drawImage(sourceCanvas,0,0);
      const imgData = ictx.getImageData(0,0,off.width,off.height);
      const d = imgData.data;
      for(let i=0;i<d.length;i+=4){
        const g = 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
        const c = (g-128)*1.2 + 128;
        d[i]=d[i+1]=d[i+2]=Math.max(0,Math.min(255,c));
      }
      ictx.putImageData(imgData,0,0);
      const { data:{ text } } = await worker.recognize(off);
      const fields = parseFields(text||'');
      if(Object.values(fields).some(v=>v)){
        fillForm(fields);
        drawBox({x:overlay.width*0.1,y:overlay.height*0.1,w:overlay.width*0.8,h:overlay.height*0.8}, 'OCR');
        toast('OCR parsed');
        return true;
      }
      return false;
    }

    async function scanFrameOnce(){
      if(!video.videoWidth){ toast('Camera not ready'); return; }
      const frame = document.createElement('canvas');
      frame.width = video.videoWidth; frame.height = video.videoHeight;
      const fctx = frame.getContext('2d');
      fctx.drawImage(video,0,0,frame.width,frame.height);
      const ok = await scanOnCanvas(frame);
      if(!ok){ toast('Nothing detected ‚Äî try moving closer, better lighting, or use photo upload.'); }
    }

    // Controls
    async function startCamera(){
      try{
        if(!isSecure){ toast('Camera requires HTTPS or localhost'); return; }
        const streamConstraints = {video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}},audio:false};
        stream = await navigator.mediaDevices.getUserMedia(streamConstraints);
        video.srcObject = stream; await video.play();
        $('placeholder').style.display='none'; video.style.display='block';
        $('start').disabled=true; $('stop').disabled=false; $('snap').disabled=false;
        if('BarcodeDetector' in window){
          const formats = ['ean_13','code_128','qr_code','upc_a','upc_e','ean_8','codabar'];
          window.__bd = new BarcodeDetector({formats});
          usingBarcodeDetector=true;
        } else {
          usingBarcodeDetector=false;
        }
        // continuous scan every 2s
        scanTimer = setInterval(scanFrameOnce, 2000);
      }catch(err){ toast('Camera error: '+err.message); log(err.message); }
    }
    function stopCamera(){
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      if(scanTimer){ clearInterval(scanTimer); scanTimer=null; }
      video.pause(); video.srcObject=null; video.style.display='none'; $('placeholder').style.display='flex';
      $('start').disabled=false; $('stop').disabled=true; $('snap').disabled=true;
    }
    $('start').onclick=startCamera;
    $('stop').onclick=stopCamera;
    $('snap').onclick=scanFrameOnce;

    // Upload photo
    $('file').onchange=async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const img = new Image();
      img.onload = async ()=>{
        const canvas = document.createElement('canvas');
        // scale down very large photos to ~1600px width for faster OCR
        const scale = Math.min(1, 1600 / img.width);
        canvas.width = Math.round(img.width * scale);
        canvas.height = Math.round(img.height * scale);
        const cctx = canvas.getContext('2d');
        cctx.drawImage(img,0,0,canvas.width,canvas.height);
        $('placeholder').style.display='none';
        // draw preview
        overlay.width = canvas.width; overlay.height = canvas.height;
        overlay.getContext('2d').drawImage(canvas,0,0);
        const ok = await scanOnCanvas(canvas);
        if(!ok){ toast('Nothing detected. Try a sharper, closer photo with good lighting.'); }
      };
      img.src = URL.createObjectURL(file);
    };
    window.removeItem = removeItem;
  </script>
</body>
</html>
