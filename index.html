<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Contact Lens Barcode Scanner ‚Äî GS1 + OCR Fallback</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;background:#0f172a;color:#e5e7eb}
  .container{max-width:1200px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:16px}
  .card{background:#0b1223;border:1px solid #1f2937;border-radius:14px;padding:14px}
  h1{font-size:1.6rem}
  .wrap{position:relative;border:1px dashed #334155;border-radius:12px;background:#0a0f1f;min-height:360px;display:flex;align-items:center;justify-content:center}
  video{max-width:100%;display:block}
  #frame{display:none}
  canvas{max-width:100%}
  #overlay{position:absolute;inset:0;pointer-events:none}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{background:#1f2937;border:1px solid #374151;border-radius:999px;padding:8px 14px;color:#fff;cursor:pointer;font-weight:600}
  .btn-primary{background:#3b82f6;border-color:#60a5fa}
  .btn-danger{background:#ef4444;border-color:#f87171}
  .pill{font-size:.8rem;background:#111827;border:1px solid #374151;border-radius:999px;padding:4px 8px}
  label{font-size:.9rem;color:#93c5fd}
  input, select{background:#0b1223;border:1px solid #334155;border-radius:10px;padding:8px 10px;color:#e5e7eb}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid #1f2937;padding:8px 6px;font-size:.95rem;text-align:left}
  th{color:#93c5fd}
  .hint{font-size:.9rem;background:#111827;border:1px solid #374151;border-radius:10px;padding:10px;color:#cbd5e1}
  .flash{box-shadow:0 0 0 3px #16a34a inset; border-radius:12px; animation:flash 350ms ease-out}
  @keyframes flash{0%{box-shadow:0 0 0 3px #16a34a inset}100%{box-shadow:0 0 0 0px rgba(0,0,0,0) inset}}
</style>
<!-- ZXing for DataMatrix decoding -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<!-- Tesseract OCR (fallback only) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>üì¶ Contact Lens Barcode Scanner ‚Äî GS1 DataMatrix + OCR Fallback</h1>
    <div class="hint">
      <b>Barcode-first</b>: scans the square GS1 DataMatrix on the box for GTIN, expiry, lot, and sometimes parameters. If no barcode is detected quickly, it runs a light <b>OCR fallback</b> on the big blue rectangle.
      Auto-logs each scan with a beep and green flash. Use <b>Export CSV</b> when done.
    </div>
  </div>

  <div class="card" id="scanCard">
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <span id="chip-env" class="pill">env</span>
      <span id="chip-bar" class="pill">barcode</span>
      <span id="chip-ocr" class="pill">ocr</span>
      <span id="chip-status" class="pill">idle</span>
    </div>
    <div class="wrap" id="wrap">
      <video id="video" playsinline></video>
      <canvas id="frame"></canvas>
      <canvas id="overlay"></canvas>
      <div id="placeholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#64748b;text-align:center;padding:10px">
        Start camera ‚Üí hold the box so the DataMatrix is inside the big blue rectangle.<br/>Beep = scanned & logged.
      </div>
    </div>
    <div class="controls">
      <button id="btnStart" class="btn btn-primary">üé• Start camera</button>
      <button id="btnStop" class="btn btn-danger" disabled>‚èπ Stop</button>
      <select id="boxSize">
        <option value="0.7" selected>Box size: 70%</option>
        <option value="0.8">Box size: 80%</option>
        <option value="0.6">Box size: 60%</option>
      </select>
      <button id="btnExport" class="btn">‚¨áÔ∏è Export CSV</button>
      <button id="btnClear" class="btn">üßπ Clear Table</button>
    </div>
  </div>

  <div class="card">
    <h3>Latest Fields</h3>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
      <div><label>Brand</label><input id="brand" readonly/></div>
      <div><label>GTIN</label><input id="gtin" readonly/></div>
      <div><label>Lot</label><input id="lot" readonly/></div>
      <div><label>Expiry</label><input id="expiry" type="date" readonly/></div>
      <div><label>Notes</label><input id="notes" placeholder="source: barcode / ocr" readonly/></div>
      <div><label>Power (SPH)</label><input id="power" readonly/></div>
      <div><label>CYL</label><input id="cyl" readonly/></div>
      <div><label>AXIS</label><input id="axis" readonly/></div>
      <div><label>BC</label><input id="bc" readonly/></div>
      <div><label>DIA</label><input id="dia" readonly/></div>
    </div>
  </div>

  <div class="card">
    <h3>Inventory (live)</h3>
    <table id="table">
      <thead>
      <tr>
        <th>Timestamp</th><th>Brand</th><th>GTIN</th><th>Lot</th><th>Expiry</th><th>Power</th><th>CYL</th><th>AXIS</th><th>BC</th><th>DIA</th><th>Notes</th>
      </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const chip=(el,txt,ok)=>{el.textContent=txt; el.style.background=ok?'#065f46':'#3f1d1d'};
const setChip=(el,label,color)=>{el.textContent=label; el.style.background=color;};
const secure = location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1';
chip($('chip-env'), secure?'Secure ‚úÖ':'Not secure (no cam) ‚ùå', secure);

// Beep on success
function beep(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type='sine'; o.frequency.value=880;
    g.gain.setValueAtTime(0.001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.25, ctx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.18);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+0.2);
    setTimeout(()=>ctx.close(),300);
  }catch(e){/* ignore */}
}

// Hardcoded GTIN map (starter set; extend as needed)
const GTIN_MAP = {
  // Johnson & Johnson (Acuvue)
  "00364220000013":"Acuvue Oasys 1-Day",
  "00364220000020":"Acuvue Moist",
  "00364220000037":"Acuvue Oasys for Astigmatism",
  "00364220000044":"Acuvue Oasys Multifocal",
  "00364220000051":"1-Day Acuvue TruEye",
  // CooperVision
  "00604603000055":"Biofinity",
  "00604603000062":"Biofinity Toric",
  "00604603000079":"Biofinity Multifocal",
  "00604603000086":"Clariti 1 Day",
  "00604603000093":"MyDay Daily Disposable",
  // Alcon
  "00731026000010":"Dailies Total1",
  "00731026000027":"Dailies AquaComfort Plus",
  "00731026000034":"Air Optix plus HydraGlyde",
  "00731026000041":"Precision1",
  "00731026000058":"Total30",
  // Bausch + Lomb
  "00193950000018":"Ultra",
  "00193950000025":"SofLens 59",
  "00193950000032":"Infuse",
  // Misc placeholders to expand quickly (you can update to your actual GTINs)
  "00000000000001":"Lens Product A",
  "00000000000002":"Lens Product B",
  "00000000000003":"Lens Product C"
};

// GS1 parsing helpers
function parseGS1(data){
  // GS1 DataMatrix can be with parentheses or FNC1 separators - we support both
  // Common AIs: (01) GTIN 14, (17) Exp YYMMDD, (10) Lot variable, (700x) extra params (manufacturer specific)
  const out={gtin:'',expiryISO:'',lot:'',params:{}};
  // Normalize: ensure parentheses form for easier regex
  let s = data;
  // If no parentheses, try to insert based on AI lengths (very rough)
  // Prefer reading parentheses if provided
  const rePairs = /\((\d{2,4})\)([^\(]+)/g;
  let m, found=false;
  while((m = rePairs.exec(s))){
    found=true;
    const ai=m[1], val=m[2].trim();
    handleAI(ai,val,out);
  }
  if(!found){
    // Fallback: FNC1-escaped style using ASCII 29 (Group Separator) ‚Äî often not visible; attempt heuristics
    // Try known fixed-length AIs first
    const GS = String.fromCharCode(29);
    const parts = s.split(GS);
    let i=0;
    while(i<parts.length){
      const seg = parts[i];
      // Match AI at start
      const aiMatch = /^(\d{2,4})/.exec(seg);
      if(!aiMatch){ i++; continue; }
      const ai = aiMatch[1];
      const rest = seg.slice(ai.length);
      let val = rest;
      if(isFixedLenAI(ai)){
        const len = fixedLengthOf(ai);
        val = rest.slice(0,len);
        // push remainder back for next iteration
        const leftover = rest.slice(len);
        if(leftover) parts.splice(i+1,0,leftover);
      }
      handleAI(ai,val,out);
      i++;
    }
  }
  return out;
}
function isFixedLenAI(ai){
  return ai==='01' || ai==='17';
}
function fixedLengthOf(ai){
  if(ai==='01') return 14; // GTIN-14
  if(ai==='17') return 6;  // YYMMDD
  return 0;
}
function handleAI(ai,val,out){
  if(ai==='01'){ out.gtin = val.replace(/[^0-9]/g,'').slice(-14); }
  else if(ai==='17'){ out.expiryISO = yymmddToISO(val); }
  else if(ai==='10'){ out.lot = val.trim(); }
  else if(/^700\d$/.test(ai)){ out.params[ai]=val.trim(); }
  // Additional AIs can be added here if your vendor encodes SPH/BC/DIA in specific ranges
}
function yymmddToISO(v){
  const m = /^(\d{2})(\d{2})(\d{2})$/.exec(v);
  if(!m) return '';
  const yy=parseInt(m[1],10), mm=m[2], dd=m[3];
  const yyyy = (yy>=70? '19'+m[1] : '20'+m[1]); // assume 2000s for modern goods; adjust if needed
  return `${yyyy}-${mm}-${dd}`;
}

// OCR fallback (lightweight numeric-first then full)
let ocrWorker=null;
async function ensureOCR(){
  if(!ocrWorker){
    setChip($('chip-ocr'),'OCR loading‚Ä¶','#92400e');
    ocrWorker = await Tesseract.createWorker({logger:()=>{}});
    await ocrWorker.loadLanguage('eng');
    await ocrWorker.initialize('eng');
    chip($('chip-ocr'),'OCR ready ‚úÖ',true);
  }
}
async function ocrNumeric(canvas){
  await ocrWorker.setParameters({
    tessedit_pageseg_mode:'6',
    tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.+-/: ',
    user_defined_dpi:'250',
    preserve_interword_spaces:'1'
  });
  const {data:{text}} = await ocrWorker.recognize(canvas);
  return text||'';
}
function cleanupText(t){
  return (t||'').toUpperCase()
    .replace(/[‚Äî‚Äì]/g,'-')
    .replace(/\bO\b/g,'0')
    .replace(/\bI\b/g,'1')
    .replace(/(\d)\s+(\d)/g,'$1$2');
}
function parseOCR(text){
  const U = cleanupText(text);
  const getNumAfter=(labelRx)=>{
    const m = labelRx.exec(U);
    if(!m) return '';
    const tail = U.slice(m.index + m[0].length);
    const n = /[+\-]?\d+(?:\.\d{1,2})?/.exec(tail);
    return n? n[0] : '';
  };
  const brand = (/(ACUVUE OASYS|ACUVUE|BIOFINITY|DAILIES|AIR OPTIX|PRECISION1|MYDAY|CLARITI|ULTRA|TOTAL|SOFLENS|INFUSE)/.exec(U)||[])[1]||'';
  let power = getNumAfter(/\b(?:PWR|POWER|SPH)[: ]*/);
  let cyl   = getNumAfter(/\bCYL[: ]*/);
  let axis  = getNumAfter(/\bAX(?:IS)?[: ]*/);
  let bc    = getNumAfter(/\bBC[: ]*/);
  let dia   = getNumAfter(/\bDIA[: ]*/);
  const mISO = /(20\d{2})[-\/\. ](0[1-9]|1[0-2])[-\/\. ](0[1-9]|[12]\d|3[01])/.exec(U);
  let expiryISO = mISO? `${mISO[1]}-${mISO[2]}-${mISO[3]}`:'';
  // sanitize
  if(power) { power = (Math.round(parseFloat(power)*4)/4).toFixed(2); }
  if(cyl)   { cyl   = (Math.round(parseFloat(cyl)*4)/4).toFixed(2); }
  if(axis)  { const ax = parseInt(axis,10); axis = (ax>=0 && ax<=180)? String(ax) : ''; }
  if(bc)    { const v=parseFloat(bc); if(v<7.8||v>9.5) bc=''; }
  if(dia)   { const v=parseFloat(dia); if(v<13.5||v>15.5) dia=''; }
  return {brand,power,cyl,axis,bc,dia,expiryISO};
}

// Inventory utilities
function fillLatest(row){
  $('brand').value=row.brand||'';
  $('gtin').value=row.gtin||'';
  $('lot').value=row.lot||'';
  $('expiry').value=row.expiry||'';
  $('power').value=row.power||'';
  $('cyl').value=row.cyl||'';
  $('axis').value=row.axis||'';
  $('bc').value=row.bc||'';
  $('dia').value=row.dia||'';
  $('notes').value=row.notes||'';
}
function addRow(row){
  const tr=document.createElement('tr');
  const ts=row.ts||new Date().toISOString().replace('T',' ').slice(0,19);
  const cells=[ts,row.brand||'',row.gtin||'',row.lot||'',row.expiry||'',row.power||'',row.cyl||'',row.axis||'',row.bc||'',row.dia||'',row.notes||''];
  for(const c of cells){ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); }
  $('tbody').prepend(tr);
}
function exportCSV(){
  const rows=[['Timestamp','Brand','GTIN','Lot','Expiry','Power','CYL','AXIS','BC','DIA','Notes']];
  document.querySelectorAll('#tbody tr').forEach(tr=>{
    const cells=[...tr.children].map(td=>td.textContent);
    rows.push(cells);
  });
  const csv = rows.map(r=>r.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='inventory_scans.csv'; a.click(); URL.revokeObjectURL(url);
}
$('btnExport').onclick=exportCSV;
$('btnClear').onclick=()=>{ $('tbody').innerHTML=''; };

// Draw big rectangle
function drawBox(octx, x,y,w,h){ octx.clearRect(0,0,octx.canvas.width,octx.canvas.height); octx.strokeStyle='#60a5fa'; octx.lineWidth=3; octx.strokeRect(x,y,w,h); }

// Main scanning logic
let barReader=null, stream=null, lastLogTime=0;
async function startCamera(){
  if(!secure){ alert('Camera requires HTTPS or localhost'); return; }
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}},audio:false});
    const video=$('video'); video.srcObject=stream; await video.play();
    $('placeholder').style.display='none'; $('btnStop').disabled=false;
    setChip($('chip-status'),'scanning‚Ä¶','#92400e');
    startBarcodeLoop();
  }catch(e){
    alert('Camera error: '+e.message);
  }
}
function stopCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  const v=$('video'); v.pause(); v.srcObject=null; $('btnStop').disabled=true;
  setChip($('chip-status'),'idle','#1f2937');
}

async function startBarcodeLoop(){
  chip($('chip-bar'),'ZXing ready ‚úÖ',true);
  if(!barReader){
    barReader = new ZXingBrowser.BrowserMultiFormatReader(new ZXingLibrary.HybridBinarizer(), {delayBetweenScanAttempts: 100});
  }
  const formats=[ZXingLibrary.BarcodeFormat.DATA_MATRIX];
  const hints = new Map(); hints.set(ZXingLibrary.DecodeHintType.POSSIBLE_FORMATS, formats);
  barReader.hints = hints;

  const video=$('video'), overlay=$('overlay'), frame=$('frame');
  const octx=overlay.getContext('2d');

  const tick = async ()=>{
    if(!stream) return;
    // Draw overlay box
    if(video.videoWidth){
      overlay.width=video.videoWidth; overlay.height=video.videoHeight;
      frame.width=video.videoWidth; frame.height=video.videoHeight;
      const pct=parseFloat($('boxSize').value||'0.7');
      const boxW = Math.round(overlay.width*pct);
      const boxH = Math.round(overlay.height*pct);
      const boxX = Math.round((overlay.width-boxW)/2);
      const boxY = Math.round((overlay.height-boxH)/2);
      drawBox(octx, boxX, boxY, boxW, boxH);
    }

    // Try decoding the whole frame (ZXing doesn't accept crop easily in browser API; the big box guides user)
    try{
      const result = await barReader.decodeOnceFromVideoElement(video);
      if(result && result.text){
        handleBarcode(result.text);
        // small cooldown to avoid rapid duplicate logs
        await new Promise(r=>setTimeout(r,400));
      }
    }catch(err){
      // If ZXing timed out, fall through to OCR fallback on the box crop
      // Extract crop
      if(video.videoWidth){
        const pct=parseFloat($('boxSize').value||'0.7');
        const boxW = Math.round(video.videoWidth*pct);
        const boxH = Math.round(video.videoHeight*pct);
        const boxX = Math.round((video.videoWidth-boxW)/2);
        const boxY = Math.round((video.videoHeight-boxH)/2);
        const fctx=frame.getContext('2d');
        fctx.drawImage(video,0,0,frame.width,frame.height);
        const crop=document.createElement('canvas'); crop.width=boxW; crop.height=boxH;
        crop.getContext('2d').drawImage(frame, boxX, boxY, boxW, boxH, 0,0, boxW, boxH);
        await ocrFallback(crop);
      }
    }finally{
      if(stream) requestAnimationFrame(tick);
    }
  };
  requestAnimationFrame(tick);
}

function brandFromGTIN(gtin){
  return GTIN_MAP[gtin] || '';
}

function successFlashBeep(){
  const wrap=$('wrap'); wrap.classList.remove('flash'); void wrap.offsetWidth; wrap.classList.add('flash'); beep();
}

function fillAndLog(row){
  fillLatest(row);
  // dedupe within 2s
  const now=Date.now(); if((now-lastLogTime)<500){ return; }
  lastLogTime=now;
  addRow(row);
  successFlashBeep();
  setChip($('chip-status'),'logged ‚úì','#065f46');
}

function handleBarcode(text){
  const gs1 = parseGS1(text);
  let brand = brandFromGTIN(gs1.gtin);
  const row={
    ts:new Date().toISOString().replace('T',' ').slice(0,19),
    brand: brand || '', gtin: gs1.gtin || '', lot: gs1.lot || '',
    expiry: gs1.expiryISO || '', power:'', cyl:'', axis:'', bc:'', dia:'',
    notes: 'barcode'
  };
  // Try to interpret any params in 700x (manufacturer-specific; not standardized here)
  // Example mapping if vendor uses 7001=SPH, 7002=CYL, 7003=AX, 7004=BC, 7005=DIA (this is hypothetical; adjust for your supplier)
  if(gs1.params['7001']) row.power = gs1.params['7001'];
  if(gs1.params['7002']) row.cyl   = gs1.params['7002'];
  if(gs1.params['7003']) row.axis  = gs1.params['7003'];
  if(gs1.params['7004']) row.bc    = gs1.params['7004'];
  if(gs1.params['7005']) row.dia   = gs1.params['7005'];

  // If brand missing from GTIN map, keep GTIN in brand for readability
  if(!row.brand && row.gtin) row.brand = 'GTIN ' + row.gtin;

  fillAndLog(row);
}

async function ocrFallback(crop){
  try{
    await ensureOCR();
    const text = await ocrNumeric(crop);
    const f = parseOCR(text);
    const row={
      ts:new Date().toISOString().replace('T',' ').slice(0,19),
      brand: f.brand || '', gtin:'', lot:'', expiry: f.expiryISO || '',
      power:f.power||'', cyl:f.cyl||'', axis:f.axis||'', bc:f.bc||'', dia:f.dia||'',
      notes: 'ocr'
    };
    if(row.brand || row.power || row.bc || row.dia || row.expiry){
      fillAndLog(row);
    }else{
      setChip($('chip-status'),'no read','#3f1d1d');
    }
  }catch(e){
    setChip($('chip-status'),'ocr error','#3f1d1d');
  }
}

// Buttons
$('btnStart').onclick=startCamera;
$('btnStop').onclick=stopCamera;
$('boxSize').onchange=()=>{ /* overlay will redraw next frame */ };
</script>
</body>
</html>